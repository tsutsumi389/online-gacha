# ガチャ演出画面 詳細設計

## 1. 画面概要
- ガチャ実行時に表示されるアニメーション・演出画面
- **演出終了後に当選アイテムを表示**
- **実装状況**: フロントエンド・バックエンド共に実装済み

## 2. 実装済み・予定演出パターン
- ✅ 通常演出（Framer Motionベース）
- ✅ 確定演出（高レアリティ時）
- ✅ 逆転演出（低レアリティからの昇格）
- 🔄 10連演出（複数同時、将来実装）

## 3. 技術仕様・UI/UX
- React + Material-UI + Framer Motionで演出実装
- APIレスポンスの`rarity`情報に基づき、演出を動的に決定
- `result` Propsで親から結果受け渡し
- パーティクル・光・星アニメ等の演出
- レスポンシブ対応（画像最適化・Picture要素）
- スキップ/戻るボタン（演出終了後のみ有効）

## 4. 主要要素
- アニメーション: Framer Motionベース、星・光・パーティクル
- 結果表示: 当選アイテム画像・名称・説明（演出終了後のみ）
- ボタン: 戻る（onBack）、もう一度引く（未実装）

## 5. レアリティの動的定義
本システムでは、DBに`rarity`カラムを持たず、ガチャ実行時にバックエンドで動的にレアリティを算出する。

- **定義**: ガチャ内の全アイテムの**初期在庫数 (`initial_stock`)** を比較し、在庫が少ないアイテムほどレア度が高いと定義する。
- **目的**: ガチャごとに異なるレアリティ分布を許容し、柔軟なガチャ設計を可能にする。
- **算出ロジック**: 在庫数を昇順に並べ、パーセンタイルでレアリティを決定する。
  - **SSR**: 在庫数が上位5%以内
  - **SR**: 在庫数が上位5%〜20%
  - **R**: 在庫数が上位20%〜50%
  - **N**: 上記以外（下位50%）

## 6. 演出分岐ロジック
フロントエンド(`GachaPerformance.js`)は、APIから渡された`rarity`文字列に応じて、再生する演出の`type`を決定する。

- **`rarity`が`SSR`または`SR`の場合**: `type='sure'`（確定演出）を設定。
  - SSRは虹色、SRは金色のエフェクトで再生される。
- **`rarity`が`R`または`N`の場合**: 確率で演出を分岐させる。
  - **80%**: `type='normal'`（通常演出）を設定。灰色のエフェクト。
  - **20%**: `type='reverse'`（逆転演出）を設定。灰色のエフェクトから金色のエフェクトに変化する。

## 7. API設計
- **POST /api/gachas/:id/draw** ... ガチャ実行
  - レスポンスに、動的に算出した`rarity`が追加される。
  - レスポンス例:
    ```json
    {
      "message": "Gacha draw successful",
      "item": {
        "id": 2,
        "name": "ノーマルアイテムB",
        "description": "普通のアイテム",
        "image_url": "/images/item2.png",
        "initial_stock": 500,
        "stock": 499
      },
      "rarity": "N",
      "result": { ... },
      "gacha": { ... }
    }
    ```

## 8. バリデーション・UX
- 戻るボタン（演出終了後のみ有効）
- 結果表示: アニメーション終了後に有効化
- API結果に基づくアイテム情報表示（レスポンシブ画像）
- fallback: デフォルト画像・情報表示
- 🔄 10連演出・BGM/SEは未実装

## 9. 実装状況・今後の拡張
### 9.1 実装済み
- **Backend**: `Gacha.js`の`draw`メソッドに、在庫数に基づく動的レアリティ算出ロジックを実装。
- **Frontend**: `GachaPerformance.js`に、APIから受け取った`rarity`に応じて演出を分岐させるロジックを実装。
- Framer Motionによる通常・確定・逆転アニメーション。
- fallback画像・情報

### 9.2 今後の拡張予定
- Three.js/PixiJS等による3D/2D演出
- 10連・複数アイテム演出
- BGM・SE
- パフォーマンス最適化

## 10. 画像最適化
- Sharp.jsで4サイズ×3フォーマット自動生成
- original/desktop/mobile/thumbnail
- AVIF→WebP→JPEGの優先順位
- Picture要素でレスポンシブ表示