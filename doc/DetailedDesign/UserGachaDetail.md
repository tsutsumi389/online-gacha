# ユーザー用 ガチャ詳細画面 詳細設計

## 1. 画面概要
- 選択したガチャの詳細情報・商品リスト・在庫・画像を表示
- 「1回引く」ボタン（10連は将来実装）
- **URL**: `/gacha/:id`（URLパラメータでID取得）

## 2. 主な機能
- URLパラメータでガチャ詳細取得
- ガチャ名・説明・価格・作成者表示
- 商品リスト（画像・商品名・残り数/全体数）
- 「1回引く」「10連引く」ボタン
- **アイテム個別在庫・総在庫数のSSEリアルタイム表示**
- **マルチユーザー環境でのリアルタイム同期**
- 戻る/進むボタン対応

## 3. 表示項目
- ガチャ名・説明・価格・作成者・公開状態
- **総在庫数表示**（現在在庫/初期在庫、リアルタイム更新）
- 商品画像（複数サイズ/フォーマット対応）
- **商品別在庫表示**（個別在庫/初期在庫、プログレスバー、リアルタイム更新）
- 商品名・説明・初期在庫・残り在庫（**SSEで即座に同期更新**）
- SOLD OUT表示（在庫0時）
- 「1回引く」「10連引く」ボタン（在庫・認証で制御）


## 4. API設計・レスポンス
### 4.1 エンドポイント
- **GET /api/gachas/:id** ... ガチャ詳細取得（アイテム情報含む）
- **POST /api/gachas/:id/draw** ... ガチャ実行（認証必須、1回・10連対応）
- **GET /api/gachas/:id/stock/stream** ... 指定ガチャの在庫数をSSEで配信
- **GET /api/gachas/:id/detail/stream** ... **ガチャ詳細画面専用SSE（アイテム個別在庫配信）**

### 4.2 レスポンス例
#### ガチャ詳細取得
```json
{
  "gacha": {
    "id": 1,
    "name": "レアアイテムガチャ",
    "description": "レアなアイテムが当たるガチャです",
    "price": 100,
    "is_public": true,
    "created_at": "2024-01-01T00:00:00.000Z",
    "updated_at": "2024-01-01T00:00:00.000Z",
    "user_id": 1,
    "creator_name": "作成者名",
    "items": [
      {
        "id": 1,
        "name": "ダイヤモンド",
        "description": "貴重なダイヤモンド",
        "image_url": "https://example.com/diamond.png",
        "image_sizes": { ... },
        "stock": 100
      }
    ]
  }
}
```
#### ガチャ実行
```json
{
  "message": "Gacha draw successful",
  "item": { ... },
  "result_id": 123
}
```
#### SSE配信データ例（ガチャ詳細用）
```json
{
  "event": "gacha-detail-update",
  "data": {
    "gachaId": 1,
    "gachaName": "レアアイテムガチャ",
    "totalStock": 250,
    "initialStock": 300,
    "items": [
      {
        "id": 1,
        "name": "ダイヤモンド",
        "stock": 45,
        "initialStock": 50
      },
      {
        "id": 2,
        "name": "ルビー",
        "stock": 0,
        "initialStock": 30
      }
    ]
  }
}
```

#### エラー例
- 400: Invalid gacha ID, No items available, All items out of stock
- 401: Unauthorized
- 404: Gacha not found or not public
- 500: Internal server error


## 5. バリデーション・UX
- ガチャID・存在・公開状態・在庫・認証を全て検証
- 商品画像: サムネイル/レスポンシブ/フォールバック対応
- **リアルタイム在庫表示**: 他のユーザーがガチャを実行すると即座に在庫数が更新
- **視覚的フィードバック**: プログレスバーで在庫割合を表示
- 残り数0: グレーアウト・SOLD OUT・ボタン無効化
- ボタン: 在庫・認証・ローディング・多重押下防止
- **SSE接続状態**: 接続エラー時の適切なエラーハンドリング
- ガチャ演出: アニメーション付きUI
- エラー: スナックバー通知


## 6. 権限制御
- 公開ガチャは全ユーザー閲覧可
- ガチャ実行は認証必須
- 非公開ガチャは表示不可
- 在庫0は抽選対象外、残り在庫は動的計算


## 7. 技術仕様
- バックエンド: Node.js + Fastify
- DB: PostgreSQL
- 認証: JWT（ガチャ実行時）
- バリデーション: Joi
- エラーハンドリング: 統一レスポンス
- フロント: React + Material-UI
- アニメーション: Framer Motion
- 状態管理: React Hooks
- **API通信**: fetch + **SSE（アイテム個別在庫・総在庫のEventSource）**
- 画像: Picture要素 + srcset（AVIF/WebP/JPEG）


## 8. データベース
- gachas: 基本情報
- gacha_items: アイテム情報
- gacha_results: 実行履歴
- users: ユーザー情報
- （probability/category/rarity列は未実装・削除済み）


## 9. リアルタイム在庫更新仕様
### 9.1 SSE接続フロー
1. **接続開始**: ガチャ詳細画面表示時に`/api/gachas/:id/detail/stream`へ接続
2. **初期データ配信**: 接続確立時にガチャ・アイテム全体の在庫情報を送信
3. **リアルタイム更新**: 他ユーザーのガチャ実行時に`gacha-detail-update`イベント配信
4. **自動切断**: 画面離脱時にSSE接続を適切にクローズ

### 9.2 マルチユーザー同期
- **シナリオ**: ユーザーAが詳細画面を開く→ユーザーBがガチャ実行→ユーザーAの画面が即座に更新
- **更新内容**: アイテム個別在庫、総在庫数、プログレスバー、ボタン有効/無効状態
- **チャンネル**: `gacha-{id}-detail`で詳細画面専用の配信チャンネルを分離

## 10. 実装状況・今後の拡張
### 10.1 完了済み
- ガチャ詳細取得API・ガチャ実行API・在庫管理・公開制御・エラーハンドリング・セキュリティ
- **SSEリアルタイム在庫更新**（アイテム個別・総在庫・マルチユーザー対応）
- フロント: UserGachaDetail.js, API連携, 状態管理, UI/UX, 画像最適化
- **1回・10連ガチャ対応**
### 10.2 今後の拡張
- ガチャ演出強化
- お気に入り・レビュー機能  
- Three.js/PixiJS演出
- 在庫アラート機能
