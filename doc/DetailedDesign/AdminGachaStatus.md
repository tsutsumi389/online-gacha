---

# マイガチャ状況確認画面 詳細設計

## **1. 概要**
マイガチャ状況確認画面では、ユーザーが作成したガチャの詳細な状況をモダンなダッシュボード形式で確認できます。この画面では、以下の情報を提供します。
- **統計サマリーカード**: 総アイテム数、残り在庫、当選者数、在庫率を視覚的に表示
- **アイテムごとの在庫状況**: レアリティ、初期在庫数、残り数、消費率をプログレスバーで可視化
- **アイテムの当選者情報**: ガチャ排出日時、当選者のユーザー名、メールアドレスをアバター付きで一覧表示
-3. **当選者情報の取得**:
   - JOINクエリが正しく実行されること
   - ユーザー情報が適切に取得されること

---

## **9. 実装状況**

### **9.1 完了済み機能**
- ✅ **モダンダッシュボードUI**: Material-UI v5 + Framer Motion
- ✅ **統計サマリーカード**: 4つのメトリクスカード（グラデーション背景）
- ✅ **レアリティ対応**: カラーコード付きチップ表示
- ✅ **プログレスバー可視化**: 在庫率・消費率の視覚的表示
- ✅ **アバター表示**: ユーザー名の初期文字によるアバター
- ✅ **アニメーション**: Framer Motionによる滑らかな表示効果
- ✅ **レスポンシブ対応**: モバイル・デスクトップ両対応
- ✅ **リフレッシュ機能**: 手動データ更新
- ✅ **日本語ローカライゼーション**: 日時表示の日本語対応

### **9.2 技術仕様**
- **フレームワーク**: React 18 + Material-UI v5
- **アニメーション**: Framer Motion
- **ルーティング**: React Router v6 (`useParams`)
- **状態管理**: React Hooks (`useState`, `useEffect`)
- **API通信**: `myGachaAPI.getGachaStatus()`

### **9.3 パフォーマンス最適化**
- **条件付きレンダリング**: データ存在チェックによる不要な描画回避
- **アニメーション最適化**: staggered animationによる段階的表示
- **メモ化**: 統計計算結果のキャッシュ
- **レスポンシブ画像**: アバターサイズの適切な制御

---

## **10. 今後の拡張予定**

### **10.1 機能拡張**
- **📊 詳細分析**: アイテム別当選統計、時系列グラフ
- **📈 トレンド表示**: 当選者数の推移、人気アイテムランキング
- **🔔 通知機能**: 在庫切れアラート、新規当選者通知
- **📤 エクスポート**: CSV/PDF形式でのデータ出力

### **10.2 UI/UX改善**
- **🎨 テーマ切り替え**: ダーク・ライトモード対応
- **📱 PWA対応**: オフライン機能、プッシュ通知
- **♿ アクセシビリティ**: スクリーンリーダー対応、キーボードナビゲーション
- **🔍 検索・フィルタ**: アイテム名、当選者での絞り込み機能

---ルタイム更新**: 手動リフレッシュ機能によるデータ更新

---

## **2. URL構造**
- **マイガチャ状況確認画面**: `/my-gacha/:id/status`
  - `:id` はガチャIDを表します。
- **実装状況**: React Routerによる動的ルーティング対応済み

---

## **3. 画面仕様**

### **3.1 レイアウト (モダンダッシュボード設計)**
- **ヘッダーセクション**:
  - ガチャ名（タイトル）、ガチャの説明を表示
  - リフレッシュボタン（手動データ更新機能）
  - アニメーション効果（Framer Motion）による滑らかな表示

- **統計サマリーカードセクション**:
  - **4つのカード**をグリッドレイアウトで配置:
    1. **総アイテム数カード** - 紫グラデーション背景
    2. **残り在庫カード** - ピンクグラデーション背景  
    3. **当選者数カード** - ブルーグラデーション背景
    4. **在庫率カード** - 動的カラー（在庫率に応じて変化）+ プログレスバー

- **アイテム在庫状況セクション**:
  - **カードベースデザイン**（従来のテーブルから進化）
  - グラデーションヘッダー（紫系）
  - **表示項目**:
    - レアリティチップ（カラーコード: SSR=オレンジ, SR=紫, R=青, C=緑）
    - アイテム名
    - 残り数（チップ形式、色分け: 0=エラー、<10=警告、>=10=成功）
    - 初期在庫数
    - 消費率（パーセンテージ + プログレスバー）
  - **特殊表示**: 在庫切れアイテムの背景色変更

- **当選者情報セクション**:
  - **カードベースデザイン**
  - グラデーションヘッダー（ピンク系）
  - **表示項目**:
    - ユーザーアバター（初期文字表示）
    - ユーザー名、メールアドレス
    - 当選日時（日本語ローカライゼーション対応）
  - ページネーション対応（20件/ページ）

---

## **4. API設計**

### **4.1 ガチャ状況取得 API**
- **エンドポイント**: `GET /api/my/:id/status`
- **認証**: JWT認証必須（作成者のみアクセス可能）
- **リクエストパラメータ**:
  - `id` (必須): ガチャID。
  - `page` (任意): ページ番号（デフォルト: 1）。
- **レスポンス例**:
```json
{
  "gacha": {
    "id": 1,
    "name": "サンプルガチャ",
    "description": "サンプルガチャの説明",
    "items": [
      {
        "id": 101,
        "name": "レアアイテムA",
        "rarity": "ssr",
        "stock": 20,
        "initial_stock": 100
      },
      {
        "id": 102,
        "name": "コモンアイテムB", 
        "rarity": "common",
        "stock": 0,
        "initial_stock": 50
      }
    ]
  },
  "winners": [
    {
      "item_id": 101,
      "user": {
        "name": "山田太郎",
        "email": "taro@example.com"
      },
      "drawn_at": "2025-08-28T12:34:56Z"
    },
    {
      "item_id": 102,
      "user": {
        "name": "鈴木花子",
        "email": "hanako@example.com"
      },
      "drawn_at": "2025-08-27T15:20:30Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 3
  }
}
```

### **4.2 統計計算ロジック**
- **フロントエンド側で算出**:
  - 総アイテム数: `gacha.items.length`
  - 総在庫数: `gacha.items.reduce((sum, item) => sum + item.stock, 0)`
  - 総初期在庫数: `gacha.items.reduce((sum, item) => sum + item.initial_stock, 0)`
  - 在庫切れアイテム数: `gacha.items.filter(item => item.stock === 0).length`
  - 在庫率: `(総在庫数 / 総初期在庫数) * 100`

---

## **5. フロントエンド設計**

### **5.1 コンポーネント構成**
- **`AdminGachaStatus.js`** (実装済み):
  - ガチャ状況画面のメインコンポーネント
  - APIからデータを取得し、統計計算を実行
  - **技術スタック**:
    - React Hooks (`useState`, `useEffect`)
    - React Router (`useParams`)
    - Material-UI v5 コンポーネント
    - Framer Motion アニメーション
  - **主要機能**:
    - 統計サマリーカードの表示
    - アイテム在庫状況テーブル
    - 当選者情報テーブル
    - ページネーション
    - リフレッシュ機能

### **5.2 デザインシステム**
- **Material-UI v5**:
  - `Container`, `Card`, `Grid`, `Table`, `Chip`, `Avatar`
  - `LinearProgress`, `Pagination`, `Typography`
- **カラーパレット**:
  - 統計カード: グラデーション背景（紫、ピンク、ブルー系）
  - レアリティ: SSR=#ff6b35, SR=#8e24aa, R=#1976d2, C=#388e3c
  - 状態表示: エラー=#f44336, 警告=#ff9800, 成功=#4caf50
- **アニメーション**: Framer Motion による滑らかな表示効果

### **5.3 レスポンシブ対応**
- **Grid システム**: `xs={12} md={3}` による統計カードの配置
- **Container**: `maxWidth="lg"` による画面幅制御
- **テーブル**: `TableContainer` によるスクロール対応

---

## **6. UI/UX詳細**

### **6.1 統計サマリーカード**
- **4つのメトリクス**:
  1. **総アイテム数**: InventoryIcon + 紫グラデーション
  2. **残り在庫**: TrendingUpIcon + ピンクグラデーション
  3. **当選者数**: PeopleIcon + ブルーグラデーション
  4. **在庫率**: プログレスバー + 動的カラー（50%以上で緑系、未満で警告色）
- **アニメーション**: staggered animation（0.1秒間隔で順次表示）

### **6.2 アイテム在庫状況セクション**
- **表示項目**:
  - レアリティチップ（カラーコード付き）
  - アイテム名（在庫切れ時は太字 + エラーカラー）
  - 残り数（Chip形式、在庫レベルに応じた色分け）
  - 初期在庫数（グレーテキスト）
  - 消費率（パーセンテージ + 60px幅プログレスバー）
- **特殊状態**:
  - 在庫切れ: 行背景 `#ffebee`、エラーカラー表示
  - 低在庫: 警告色（<10個）
- **ホバーエフェクト**: 行にマウスオーバー時の背景色変化

### **6.3 当選者情報セクション**
- **表示項目**:
  - ユーザーアバター（32x32px、初期文字表示）
  - ユーザー名（fontWeight: medium）
  - メールアドレス（グレーテキスト）
  - 当選日時（日本語ロケール: `toLocaleString('ja-JP')`）
- **レイアウト**: Stack layout によるアバター + 名前の横並び配置

### **6.4 ページネーション**
- **Material-UI Pagination**: 
  - カラー: primary
  - サイズ: large
  - 機能: showFirstButton, showLastButton
- **条件表示**: totalPages > 1 の場合のみ表示

---

## **7. バックエンド設計**

### **7.1 データベース構造**
- **`gacha_items` テーブル**:
  - `stock` カラム: 現在の残り在庫数を保持
  - `rarity` カラム: アイテムレアリティ ('common', 'rare', 'srare', 'ssr')
  - **注意**: `initial_stock` カラムは存在しないため、フロントエンドで算出が必要
- **`gacha_results` テーブル**:
  - `user_id` カラム: 当選者のユーザーID
  - `item_id` カラム: 当選アイテムのID
  - `created_at` カラム: ガチャ排出日時

### **7.2 API実装ロジック**
- **認証チェック**: JWT ミドルウェアによる所有者確認
- **データ取得**:
  - ガチャ情報 + アイテム一覧の取得
  - `gacha_results` テーブルを `users` テーブルと JOIN して当選者情報取得
  - ページネーション処理（LIMIT, OFFSET）

### **7.3 セキュリティ**
- **所有者ベースアクセス制御**: ガチャ作成者のみがアクセス可能
- **パラメータ検証**: ガチャIDの数値チェック
- **SQLインジェクション対策**: パラメータ化クエリ使用

---

## **8. テストケース**

### **8.1 フロントエンド**
1. **統計カード表示**:
   - 4つの統計カードが正しく表示されること
   - 在庫率プログレスバーが正確に計算されること
   - アニメーション効果が滑らかに動作すること

2. **在庫状況の表示**:
   - レアリティチップが正しい色で表示されること
   - 消費率プログレスバーが正確に表示されること
   - 在庫切れアイテムが特別な表示になること

3. **当選者情報の表示**:
   - アバターアイコンが正しく表示されること
   - 日本語ローカライゼーションが適用されること
   - ユーザー名、メールアドレス、排出日時が正しく表示されること

4. **インタラクション**:
   - リフレッシュボタンでデータが更新されること
   - ページネーションが正しく動作すること
   - ホバーエフェクトが適用されること

5. **レスポンシブ対応**:
   - 統計カードがモバイルで縦並びになること
   - テーブルが横スクロール対応されること

### **8.2 バックエンド**
1. **API認証**:
   - 未認証ユーザーがアクセス拒否されること
   - 他人のガチャにアクセス拒否されること

2. **APIレスポンス**:
   - 正しいガチャ状況データが返却されること
   - レアリティ情報が含まれること
   - ページネーション情報が正確であること

3. **在庫数の整合性**:
   - ガチャ実行時に `stock` が正しくデクリメントされること
   - 在庫切れ時にガチャ実行が拒否されること

4. **当選者情報の取得**:
   - JOINクエリが正しく実行されること
   - ユーザー情報が適切に取得されること

---