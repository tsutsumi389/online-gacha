# ガチャ管理画面 詳細設計 ✅ バックエンド実装完了

## 1. 画面概要
- ガチャの新規作成・編集・削除・アイテム管理を行うための管理画面
- ガチャごとにアイテムリストや在庫数などを管理
- すべてのユーザーが自分のガチャを管理可能
- **実装状況**: バックエンドAPI完全実装済み、フロントエンド実装待ち

## 2. 画面構成

### 2.1 ガチャ一覧画面（AdminGachaManage）
- ガチャ一覧表示（ページネーション対応）
  - ガチャ名、説明、価格、公開状態、作成日時
  - 公開/非公開の切り替えスイッチ
- 新規ガチャ作成ボタン
- 各ガチャの編集・削除ボタン
- 検索・フィルタ機能（将来対応）

### 2.2 ガチャ編集/新規作成画面（AdminGachaEdit）
- 基本情報入力
  - ガチャ名（必須、最大128文字）
  - 説明文（最大1000文字）
  - 価格（必須、1以上の整数）
  - 公開/非公開切替
  - 表示期間（開始日・終了日、任意）
- アイテム管理セクション（ガチャ作成後に表示）
  - アイテム一覧テーブル
  - アイテム名、在庫数、公開状態、画像
  - アイテムの追加・編集・削除機能
- 保存/キャンセルボタン
- 一覧に戻るボタン

### 2.3 アイテム編集ダイアログ
- アイテム名（必須、最大128文字）
- 説明（最大1000文字）
- 在庫数（0以上の整数）
- 画像URL（任意）
- 公開/非公開切替
- 保存/キャンセルボタン

### 2.4 削除確認ダイアログ
- ガチャ削除時の確認メッセージ
- 削除/キャンセルボタン
- アイテム削除時の確認メッセージ

## 3. 画面遷移イメージ
- ガチャ管理一覧 → [新規作成] → ガチャ編集画面 → 成功メッセージ表示 → アイテム管理可能
- ガチャ管理一覧 → [編集] → ガチャ編集画面（アイテム管理含む）
- ガチャ管理一覧 → [削除] → 削除確認ダイアログ
- ガチャ編集画面 → [アイテム追加] → アイテム編集ダイアログ
- アイテム一覧 → [編集] → アイテム編集ダイアログ
- アイテム一覧 → [削除] → 削除確認ダイアログ

## 4. バリデーション・UX
- 必須項目未入力時は保存不可
- ガチャ名: 1-128文字、必須
- 説明: 0-1000文字
- 価格: 1以上の整数、必須
- アイテム名: 1-128文字、必須
- 在庫数: 0以上の整数
- 画像URL: 有効なURL形式
- 新規ガチャ作成成功時は成功メッセージ表示
- アイテム管理セクションは動的に表示
- エラー時は詳細なエラーメッセージを表示

## 5. API設計 ✅ 実装完了
### 5.1 管理用エンドポイント（/api/admin/*）
- ✅ GET /api/admin/gachas ... ユーザーのガチャ一覧取得（ページネーション対応）
- ✅ POST /api/admin/gachas ... ガチャ新規作成
- ✅ PUT /api/admin/gachas/:id ... ガチャ編集
- ✅ DELETE /api/admin/gachas/:id ... ガチャ削除
- ✅ PATCH /api/admin/gachas/:id/publish ... 公開状態切り替え
- ✅ GET /api/admin/gachas/:id/items ... アイテム一覧取得
- ✅ POST /api/admin/gachas/:id/items ... アイテム追加
- ✅ PUT /api/admin/gachas/:gachaId/items/:itemId ... アイテム編集
- ✅ DELETE /api/admin/gachas/:gachaId/items/:itemId ... アイテム削除

### 5.2 認証・セキュリティ
- ✅ JWT認証による本人確認
- ✅ ガチャオーナーシップ検証（本人のガチャのみ管理可能）
- ✅ SQLインジェクション対策（パラメータ化クエリ）
- ✅ 入力値検証（Joi）

### 5.3 レスポンス形式
```json
// ガチャ一覧取得レスポンス
{
  "gachas": [
    {
      "id": 1,
      "name": "レアアイテムガチャ",
      "description": "レアなアイテムが当たるガチャです",
      "price": 100,
      "is_public": true,
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 50,
    "page": 1,
    "limit": 10,
    "totalPages": 5
  }
}

// アイテム一覧取得レスポンス
{
  "items": [
    {
      "id": 1,
      "name": "ダイヤモンド",
      "description": "貴重なダイヤモンド",
      "stock": 100,
      "image_url": "https://example.com/diamond.png",
      "is_public": true
    }
  ]
}
```

## 6. 技術仕様 ✅ バックエンド実装完了
### 6.1 実装済み技術スタック
- ✅ バックエンド: Node.js + Fastify + JWT認証
- ✅ データベース: PostgreSQL（完全スキーマ対応）
- ✅ バリデーション: Joi（バックエンド）
- ✅ 認証: JWT + ミドルウェア認証
- ✅ エラーハンドリング: 統一されたエラーレスポンス形式
- ✅ セキュリティ: パラメータ化クエリ、オーナーシップ検証

### 6.2 実装待ち技術スタック
- 🔄 フロントエンド: React 18 + Material-UI + Framer Motion
- 🔄 Cookie認証: HTTPOnly Cookie（現在はHeaderベース）

### 6.3 データベース実装状況
- ✅ gachas テーブル: 完全対応（is_public列使用）
- ✅ gacha_items テーブル: 完全CRUD対応
- ✅ users テーブル: 認証対応
- ✅ マイグレーション: 最新スキーマ適用済み

## 7. 実装完了事項・備考
### 7.1 完了済み機能
- ✅ 管理用APIエンドポイント全機能
- ✅ JWT認証システム
- ✅ ガチャCRUD操作（作成・読取・更新・削除）
- ✅ アイテムCRUD操作（作成・読取・更新・削除）
- ✅ 公開状態切り替え機能
- ✅ オーナーシップ検証（本人のガチャのみアクセス可）
- ✅ 入力値検証とエラーハンドリング
- ✅ ページネーション対応

### 7.2 実装待ち機能
- 🔄 レスポンシブデザイン対応（スマホ・PC）
- 🔄 Material-UIコンポーネントを使用したモダンなUI
- 🔄 リアルタイムでの状態更新（公開/非公開切り替え等）
- 🔄 フロントエンド全画面実装

### 7.3 開発メモ
- データベーススキーマは統一済み（is_public列使用）
- 認証ミドルウェアによる自動的な本人確認
- エラーレスポンスの標準化完了
- API テスト完了（curl による動作確認済み）
