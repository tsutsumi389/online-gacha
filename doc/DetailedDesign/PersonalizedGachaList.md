# パーソナライズドガチャ一覧設計書

## 1. 画面概要
- 既存のガチャ一覧画面を拡張し、ユーザーの趣味嗜好に基づくパーソナライゼーション機能を追加
- ユーザー設定に応じた表示順変更、カテゴリフィルタリング、おすすめ度表示機能
- 公開（ログイン不要）とパーソナライズ（ログイン必要）の両方に対応
- **URL**: `/gacha` （既存画面の拡張）
- **遷移先**: ガチャ詳細画面（`/gacha/:id`）、ユーザー設定画面（`/profile/preferences`）

## 2. 主な機能
- 拡張されたソート機能（おすすめ順、評価順を追加）
- カテゴリベースのフィルタリング（複数選択対応）
- パーソナライゼーション状態表示とガイダンス
- おすすめ度の可視化（星評価）
- カテゴリタグとガチャメタ情報の表示
- 人気度バッジとお気に入りアイコンの表示
- ユーザー評価（平均評価・レビュー件数）の表示
- 既存機能の継承（検索、ページネーション、SSE在庫更新）

## 3. UI/UX特徴
- 既存のMaterial-UI + Framer Motionデザインを拡張
- パーソナライゼーション状態に応じたアラート表示
- 直感的なカテゴリフィルター（チップ形式）
- おすすめ度の視覚的表現（星評価）
- ログイン状態による機能の動的表示/非表示
- レスポンシブ対応（モバイル最適化）
- アクセシビリティ配慮（キーボード操作、スクリーンリーダー）
- プログレッシブ・エンハンスメント

## 4. 表示データ項目
- **既存項目**: name, description, price, creator_name, creator_avatar_url, item_count, play_count
- **新規項目**: 
  - personalization_score: おすすめ度スコア（1-10）
  - categories: 所属カテゴリ配列
  - average_rating: 平均評価（1-5星）
  - rating_count: レビュー件数
  - is_favorite: お気に入り状態
  - is_popular: 人気バッジ表示フラグ
  - popularity_rank: 人気ランキング順位

## 5. API設計
- **GET /api/gachas** ... 拡張されたガチャ一覧取得（既存APIの拡張）
  - 既存パラメータ: search, filter, sortBy, sortOrder, page, limit
  - 新規パラメータ: 
    - category: カテゴリIDのカンマ区切り（例: `1,3,5`）
    - personalized: パーソナライゼーション有効フラグ
  - レスポンス拡張: personalization_score, categories, ratings情報等

- **GET /api/gacha-categories/with-counts** ... カテゴリ別ガチャ件数付き一覧
  - レスポンス: category_id, name, gacha_count

- **POST /api/user/gacha-favorite** ... お気に入り追加/削除
  - リクエスト: gacha_id, is_favorite

## 6. バリデーション・UX
- パーソナライゼーション無効時の適切なフォールバック
- カテゴリフィルター選択時のリアルタイム更新
- ログイン状態変化時のUI更新
- 大量データに対するページネーション
- フィルター適用中のローディング状態表示
- 検索結果なしの場合の適切なメッセージ
- エラー時の適切なフィードバック

## 7. 権限制御
- 一覧閲覧: 全ユーザー（認証不要）
- パーソナライゼーション機能: ログインユーザーのみ
- お気に入り機能: ログインユーザーのみ
- 評価機能: ログインユーザーのみ
- 公開ガチャのみ表示（is_public = true）
- 公開期間内のガチャのみ表示

## 8. 技術仕様
- フロントエンド: React 18 + Material-UI v5（既存を拡張）
- 状態管理: React Hooks + URLクエリパラメータ
- API通信: Fetch API with utils/api.js
- UI拡張: Autocomplete, Chip, Rating, Badge, Alert
- 既存技術の継承: Swiper.js, Framer Motion, SSE
- レスポンシブ画像: Sharp.js処理済み画像の継承
- URL状態管理: ブラウザ履歴との統合

## 9. エラーハンドリング
- パーソナライゼーションAPI呼び出し失敗時のフォールバック
- カテゴリ取得失敗時のデフォルト表示
- ネットワークエラー時の再試行機能
- 不正なフィルター値の適切なハンドリング
- レーティング機能のエラー処理

## 10. パフォーマンス考慮
- 既存の最適化機能を継承（画像遅延読み込み、SSE）
- カテゴリフィルター時のデバウンス処理
- パーソナライゼーションスコア計算の最適化
- メモ化による不要な再計算防止
- 仮想スクロール（大量データ対応）
- URLクエリパラメータでの状態保持

## 11. 今後の拡張予定
- より高度なパーソナライゼーションアルゴリズム
- A/Bテスト機能との統合
- ソーシャル機能（シェア、コメント）
- レコメンドエンジンの強化
- 機械学習ベースの推薦システム
- ユーザー行動分析の強化