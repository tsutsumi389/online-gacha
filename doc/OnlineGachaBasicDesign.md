---

# オンラインガチャシステム 基本設計書（ドラフト）

## 1. システム概要

本システムは、ユーザーがオンライン上でガチャを引き、商品を獲得できるWebサービスです。すべてのユーザーはガチャを作成・管理することも、他のユーザーが作成したガチャを引くこともできます。システムはDocker環境上で動作し、データベースにはPostgreSQLを使用します。

## リアルタイム在庫更新（SSE）
ガチャの在庫数は、サーバー・クライアント間でServer-Sent Events（SSE）を用いてリアルタイムに同期されます。複数ユーザーが同時にガチャを引いた場合でも、在庫数が即時に全クライアントへ反映され、SOLD OUT表示や在庫数のズレが発生しません。

### SSEによる在庫更新の流れ
1. クライアントはガチャ詳細画面（`/gacha/:id`）表示時にSSEエンドポイント（例: `/api/gachas/:id/stock/stream`）へ接続します。
2. サーバー側は在庫数の変更（ガチャ実行・管理画面での編集等）が発生した際、該当ガチャIDのSSEストリーム購読者全員に最新在庫数をpushします。
3. クライアントは受信した在庫数でUIを即時更新し、SOLD OUT時はボタン非活性・表示切替を行います。

#### 技術ポイント
- SSE（Server-Sent Events）による一方向リアルタイム通信（HTTP/1.1対応、WebSocket不要）
- バックエンドはFastify + fastify-sseプラグイン等で実装
- クライアントはEventSource APIで購読
- 在庫数以外のリアルタイム情報（例: ガチャ実行履歴、当選演出等）拡張も容易

## 2. ユーザー権限

| ユーザーロール   | 主な権限・機能                                                               |
|------------------|-----------------------------------------------------------------------------|
| 全ユーザー       | ガチャ一覧閲覧、ガチャ詳細閲覧、ガチャ実行、自分のガチャ作成・編集・削除      |

**注意**: すべてのユーザーは同等の権限を持ち、ガチャの作成と実行の両方が可能です。管理者という特別な権限は現在の実装には存在しません。

## 3. 画面仕様・URL構造 ✅ URL分離実装完了


### 3.1 ガチャを引く側の機能

- **ガチャ一覧画面** ✅ URL分離完了
	- **URL**: `/gacha`
	- 利用可能なガチャのリスト表示
	- 各ガチャの簡易情報（名称、価格、提供割合など）
	- 自分が作成したガチャと他のユーザーが作成したガチャを区別表示
	- ガチャ詳細画面への遷移リンク

- **ガチャ詳細画面** ✅ 実装完了・URL分離完了
	- **URL**: `/gacha/:id`
	- ガチャの詳細情報（商品リスト、各商品の当選確率、説明）
	- 実際のAPIからデータ取得・表示
  - 在庫状況の動的表示・SOLD OUT表示（SSEによるリアルタイム反映）
	- 作成者情報・アイテム数・提供期間表示
	- レスポンシブ対応のカード形式レイアウト
	- URL パラメータからガチャIDを取得

- **ガチャ演出画面** ✅ 実装完了
	- ガチャ演出（リッチなアニメーション、パーティクル、2D/3D表現など）
	  - Framer MotionによるUIアニメーション ✅
	  - 実際のAPIレスポンスに基づく結果表示 ✅
	  - 獲得アイテムの詳細情報表示 ✅
	- 結果表示（当選商品） ✅

### 3.2 ガチャを作る側の機能

- **マイガチャ管理画面** ✅ URL分離完了
	- **URL**: `/my-gacha`
	- 自分が作成したガチャのリスト表示（ページネーション対応）
	- 編集・削除・新規作成ボタン
	- 公開/非公開の即座切り替え
	- ガチャの実行統計表示（将来対応）
	- ガチャ編集画面への遷移リンク

- **ガチャ新規作成画面** ✅ URL分離完了
	- **URL**: `/my-gacha/new`
	- ガチャ名、説明、価格、公開状態、表示期間の新規登録
	- 保存後は自動的にガチャ編集画面に遷移してアイテム管理可能

- **ガチャ編集画面** ✅ URL分離完了
	- **URL**: `/my-gacha/edit/:id`
	- ガチャ名、説明、価格、公開状態、表示期間の編集
	- アイテム管理機能（アイテム名、説明、画像URL、在庫数）
	- URL パラメータからガチャIDを取得
	- 既存ガチャの情報を自動読み込み
	- 新規作成後は自動的にアイテム管理セクションを表示
	- リアルタイムバリデーションとエラー表示

### 3.3 認証関連画面

- **ログイン画面**
	- メールアドレス・パスワード入力フォーム
	- ログインボタン
	- 新規登録画面へのリンク
	- パスワードリセット機能（将来対応）
	- ソーシャルログイン対応（Google、GitHub等）（将来対応）

- **新規登録画面**
	- ユーザー名、メールアドレス、パスワード入力フォーム
	- パスワード確認入力
	- 利用規約同意チェックボックス
	- 登録ボタン
	- ログイン画面へのリンク

- **プロフィール画面**
	- ユーザー情報表示・編集
	- 作成したガチャ一覧
	- ログアウト機能

- **ガチャ履歴画面** ✅ 実装完了
	- **URL**: `/gacha-history`
	- ユーザーのガチャ実行履歴を時系列表示
	- 表示項目: 実行日時、ガチャ名、獲得アイテム名、アイテムサムネイル画像
	- ページネーション対応（20件/ページ）
	- 認証が必要（PrivateRoute）
	- ヘッダーのユーザーアイコンメニューから遷移

### 3.4 共通ヘッダー仕様**【✅ 実装完了】**

全画面に共通表示されるヘッダーバー（AppBar）の仕様を定義します。

#### 3.4.1 ヘッダー基本構成
- **左側**: サイトロゴ + サイト名「オンラインガチャ」
- **中央**: ナビゲーションメニュー
  - 「ガチャ一覧」（/gacha）
  - 「マイガチャ」（/my-gacha）※ログイン時のみ表示
- **右側**: ユーザー関連メニュー

#### 3.4.2 ユーザーアイコン機能**【✅ 実装完了】**

**ログイン済み状態**:
- **表示**: ユーザーアバター画像（32px円形）
- **アバター仕様**:
  - 設定済み: user_avatar_variants.image_url (avatar_64.avif)
  - 未設定: ユーザー名の頭文字をアイコン表示
- **クリック動作**: ドロップダウンメニュー表示
  - 「プロフィール」→ `/profile` へ遷移
  - 「ガチャ履歴」→ `/gacha-history` へ遷移 ✅ 実装完了
  - 「ログアウト」→ ログアウト実行

**未ログイン状態**:
- **表示**: 「ログイン」「登録」ボタン
- **アバターアイコン**: 非表示

#### 3.4.3 技術仕様
- **コンポーネント**: Material-UI AppBar + Avatar + Menu
- **認証状態管理**: React Context API
- **アバター画像**: Sharp.js処理済みAVIF画像（64px→32px表示）
- **メニュー制御**: Material-UI Menu コンポーネント
- **レスポンシブ**: モバイル時はハンバーガーメニュー化

#### 3.4.4 ユーザビリティ
- アバタークリックでのメニュー表示・非表示
- メニュー外クリックでの自動クローズ
- キーボードアクセシビリティ（Tab/Enter操作）
- ホバー時のツールチップ表示
- ログアウト時の確認ダイアログ（オプション）


## 3.x ガチャ在庫リアルタイム同期設計

### 概要
ガチャ詳細画面では、在庫数が他ユーザーの操作によって変動した場合も即時にUIへ反映されます。これにより、在庫切れ時の誤操作や在庫数のズレを防止します。

### サーバー側
- SSEエンドポイント `/api/gachas/:id/stock/stream` を提供
- 在庫数が変更されるたびに該当ガチャIDの購読者へ最新在庫数を送信
- Fastify + fastify-sse等で実装

### クライアント側
- ガチャ詳細画面でEventSourceを用いてSSE購読
- 受信した在庫数でUIを即時更新
- SOLD OUT時はボタン非活性・表示切替

### メッセージ仕様（例）
```json
event: stock_update
data: { "gachaId": 123, "stock": 5 }
```

### 拡張性
- 今後、ガチャ実行履歴や当選演出のリアルタイム配信にもSSEを活用可能

- **Webアプリケーション**
	- フロントエンド：React + Material-UI + React Hook Form
	  - React Router: ページルーティング
	  - React Hook Form + Yup: フォーム管理・バリデーション
	  - Material-UI: UIコンポーネント
	  - Framer Motion: UIアニメーション
	  - Three.js / PixiJS: ガチャ演出（2D/3Dアニメーション、パーティクル等）
	- バックエンド：Node.js（Fastify）+ JWT認証
	  - Fastify: 高速Webフレームワーク
	  - JWT: ステートレス認証
	  - bcrypt: パスワードハッシュ化
	  - PostgreSQL: データベースアクセス
	  - MinIO Client: オブジェクトストレージアクセス
	  - Sharp.js: 高性能画像処理（リサイズ、AVIF変換、最適化）
- **DB**：PostgreSQL
- **ストレージ**：MinIO（S3互換オブジェクトストレージ）
	- ガチャアイテム画像の保存・配信
	- ユーザープロフィール画像の保存（将来対応）
	- 画像の自動リサイズ・最適化（Sharp.js + AVIF形式対応）
	- 複数サイズ画像生成（オリジナル、サムネイル、モバイル用、高解像度用）
- **インフラ**：Docker（docker-composeでWeb/DB/MinIOを構築）

### 4.1 認証システム
- **認証方式**: JWT（JSON Web Token）
- **セッション管理**: HttpOnly Cookie
- **パスワード**: bcryptでハッシュ化
- **セキュリティ**: CORS設定、レート制限対応

## 5. データベース設計（概略）

- users（ユーザー情報）- roleカラム削除済み
- gachas（ガチャ情報）- user_idでユーザーと関連付け
- gacha_items（ガチャ内のアイテム情報）- rarityカラムなし、image_urlはMinIO上のオブジェクトキーを格納
- gacha_results（ガチャ実行履歴）- 将来実装予定
- user_images（ユーザー画像情報）- MinIO上のプロフィール画像管理、将来実装予定

### 5.1 画像管理設計
- **保存先**: MinIO (S3互換オブジェクトストレージ)
- **画像処理**: Sharp.js（高性能画像処理ライブラリ）
- **画像形式**: AVIF形式（次世代画像フォーマット、WebP/JPEGのfallback対応）
- **複数サイズ生成**:
  - オリジナル: 元ファイルのAVIF変換版（最大2048x2048）
  - サムネイル: 150x150px（アイテム一覧用）
  - モバイル用: 512x512px（スマートフォン表示用）
  - 高解像度用: 1024x1024px（PC・タブレット表示用）
- **バケット構成**:
  - `gacha-images`: ガチャアイテム画像（4サイズ保存）
  - `user-images`: ユーザープロフィール画像（将来対応）
- **画像URL形式**: `http://localhost:9000/gacha-images/{サイズ}/{オブジェクトキー}`
- **アクセス制御**: パブリック読み取り許可（画像表示用）
- **サイズ制限**: アップロード時最大10MB、圧縮後はサイズ最適化
- **レスポンシブ画像配信**: 端末に応じた最適サイズの自動選択


## 6. 機能一覧

| 機能名             | 概要                                         | 対象ユーザー   | 認証要否 | 実装状況 |
|--------------------|----------------------------------------------|---------------|----------|----------|
| ユーザー登録       | 新規アカウント作成                           | 未登録ユーザー | 不要     | ✅ 完了   |
| ログイン           | メールアドレス・パスワードでログイン         | 登録済みユーザー | 不要     | ✅ 完了   |
| ログアウト         | セッション終了                               | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ一覧表示     | 公開ガチャのリスト表示・検索・ソート機能     | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャカテゴリ一覧 | ガチャカテゴリの取得                         | 全ユーザー    | 不要     | ✅ 完了   |
| 人気ガチャ一覧     | プレイ回数順での人気ガチャ表示               | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ統計情報     | ガチャ数・プレイ数・プレイヤー数の統計       | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ詳細表示     | ガチャの詳細情報を表示（在庫SSEリアルタイム反映） | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ実行         | ガチャを引き、結果を表示                     | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ在庫リアルタイム同期 | 在庫数のSSEリアルタイム配信・UI反映      | 全ユーザー    | 不要     | ✅ 完了   |
| マイガチャ管理     | 自分が作成したガチャの一覧・管理             | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ作成・編集   | ガチャの新規作成・編集・削除                  | ログイン済み   | 必要     | ✅ 完了   |
| アイテム管理       | ガチャ内アイテムの登録・編集・削除            | ログイン済み   | 必要     | ✅ 完了   |
| 画像アップロード   | アイテム画像のMinIOへのアップロード          | ログイン済み   | 必要     | ❌ 未実装 |
| 画像管理           | アップロード済み画像の一覧・削除              | ログイン済み   | 必要     | ❌ 未実装 |
| プロフィール管理   | ユーザー情報編集・アバター設定               | ログイン済み   | 必要     | ✅ 完了   |
| ヘッダーアイコン   | ヘッダーのユーザーアバター表示・メニュー     | ログイン済み   | 必要     | ✅ 完了   |

## 7. Docker構成

- web: Webアプリケーション
- frontend: Reactフロントエンド（開発環境）
- db: PostgreSQL
- minio: MinIO（S3互換オブジェクトストレージ）
- minio-init: MinIO初期化（バケット作成・設定）

```yaml
version: '3'
services:
  web:
    build: ./web
    ports:
      - "8080:8080"
    depends_on:
      - db
      - minio
    env_file:
      - .env
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: gacha_db
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_password
    ports:
      - "9000:9000"  # MinIO API
      - "9001:9001"  # MinIO Console
    volumes:
      - minio_data:/data
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minio_user minio_password;
      mc mb myminio/gacha-images;
      mc anonymous set download myminio/gacha-images;
      echo 'MinIO初期化完了';
      "
    restart: "no"
volumes:
  db_data:
  minio_data:
```

## 8. 今後の検討事項

- 認証・認可方式の強化
- 決済機能の有無
- 商品発送管理の有無
- CDN連携による画像配信の高速化
- 画像のメタデータ管理（サイズ、フォーマット、アップロード日時等）
- 画像の不正利用対策（透かし、アクセス制限等）
- WebP・JPEG fallback対応（古いブラウザサポート）
- 画像の遅延読み込み・プリロード機能
- 画像圧縮率の動的調整

## 9. 最新の変更履歴

### 2025年8月23日 - Sharp.js画像処理システム統合設計
- **画像処理エンジン**:
  - Sharp.js統合: 高性能画像処理ライブラリ
  - AVIF形式対応: 次世代画像フォーマット（50%以上のファイルサイズ削減）
  - WebP/JPEG fallback: ブラウザサポート確保

- **複数サイズ画像生成**:
  - オリジナル: 最大2048x2048px（AVIF形式）
  - サムネイル: 150x150px（一覧表示用）
  - モバイル用: 512x512px（スマートフォン最適化）
  - 高解像度用: 1024x1024px（PC・タブレット用）

- **レスポンシブ画像配信**:
  - フロントエンド自動選択: デバイス・画面サイズに応じた最適画像
  - ブラウザサポート判定: AVIF未対応時のWebP/JPEG自動切り替え
  - 遅延読み込み対応: 表示領域に入った時点で画像読み込み

- **システム構成更新**:
  - アップロード時の自動処理: 4サイズ×3フォーマット生成
  - MinIOバケット構造変更: サイズ別ディレクトリ構成
  - データベーススキーマ拡張: 画像メタデータテーブル追加予定

### 2025年8月24日 - ユーザーアバターシステム統合**【✅ 実装完了】**
- **ユーザーアイコン機能**:
  - プロフィール画面でのアバター変更機能
  - Sharp.js処理: AVIF形式、4サイズ（32px/64px/128px/256px）自動生成
  - データベース設計: user_avatar_images, user_avatar_variants テーブル追加

- **ヘッダーアイコン機能**:
  - ログイン時のユーザーアバター表示（32px円形）
  - クリックメニュー: 「プロフィール」「ログアウト」
  - 未ログイン時: アバター非表示、ログイン/登録ボタン表示
  - レスポンシブ対応: モバイル時ハンバーガーメニュー化

- **統合表示機能**:
  - ガチャ一覧でのクリエイターアイコン表示
  - 64px画像を32pxサイズで表示
  - アイコン未設定時の頭文字フォールバック

### 2025年8月22日 - MinIO画像ストレージ統合
- **インフラ改修**:
  - MinIOコンテナの追加: S3互換オブジェクトストレージ
  - docker-compose.yml: MinIOサービスと初期化スクリプトの追加
  - 環境変数: MinIO接続設定の追加（.env）

- **画像管理設計**:
  - 画像保存先をMinIOに変更（従来のローカルファイルシステムから移行）
  - バケット構成: `gacha-images`（アイテム画像）、`user-images`（プロフィール画像、将来対応）
  - アクセス制御: パブリック読み取り許可による直接画像表示
  - ファイル制限: 最大5MB、JPEG/PNG/WebP対応

- **システム構成更新**:
  - バックエンド: MinIO Clientライブラリの統合予定
  - データベース設計: gacha_itemsのimage_urlをMinIOオブジェクトキー対応
  - 新機能追加予定: 画像アップロード・管理機能

### 2025年8月21日 - URL構造の分離実装
- **フロントエンド改修**:
  - ガチャ一覧とガチャ詳細のURL分離: `/gacha` → `/gacha/:id`
  - マイガチャ管理とガチャ編集のURL分離: `/my-gacha` → `/my-gacha/edit/:id`
  - 新規ガチャ作成の独立URL: `/my-gacha/new`

- **ルーティング改善**:
  - React Router による URL パラメータベースのナビゲーション
  - 各コンポーネントの props 依存からURL パラメータ依存への移行
  - ブラウザの戻る/進むボタン対応の改善

- **コンポーネント修正**:
  - `AdminGachaEdit.js`: URL パラメータからガチャID取得に変更
  - `UserGachaDetail.js`: URL パラメータによるガチャ詳細取得
  - `App.js`: 新しいルーティング構造の実装

- **API修正**:
  - バックエンドAPI endpoints の修正
  - Gacha.js model の update メソッド強化
  - admin.js routes の endpoint 実装改善

---
