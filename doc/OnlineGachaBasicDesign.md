---

# オンラインガチャシステム 基本設計書（2025年8月最新版）

## 1. システム概要

本システムは、全ユーザーが「ガチャを作る」「ガチャを引く」両方を楽しめるオンラインWebサービスです。
- ガチャ作成・管理・実行・履歴・プロフィール管理まで一貫して提供
- 画像はMinIO（S3互換）+ Sharp.jsで高圧縮・多サイズ自動生成
- Docker ComposeでWeb/DB/ストレージ一括構築
- DBはPostgreSQL16

## 2. リアルタイム在庫更新（SSE）
ガチャの在庫数はSSE（Server-Sent Events）でリアルタイム同期。
- ガチャ一覧・詳細画面で在庫数が即時反映
- SOLD OUT時はUI自動切替
- SSEエンドポイント例: `/api/gachas/stock/stream`, `/api/gachas/:id/stock/stream`

### SSEによる在庫更新の流れ
1. クライアントはガチャ詳細画面（`/gacha/:id`）表示時にSSEエンドポイント（例: `/api/gachas/:id/stock/stream`）へ接続します。
2. サーバー側は在庫数の変更（ガチャ実行・管理画面での編集等）が発生した際、該当ガチャIDのSSEストリーム購読者全員に最新在庫数をpushします。
3. クライアントは受信した在庫数でUIを即時更新し、SOLD OUT時はボタン非活性・表示切替を行います。

#### 技術ポイント
- SSE（Server-Sent Events）による一方向リアルタイム通信（HTTP/1.1対応、WebSocket不要）
- バックエンド: Fastify + fastify-sse
- クライアント: EventSource API
- 在庫数以外のリアルタイム情報（履歴・演出等）も拡張可能

## 3. ユーザー権限

| ユーザーロール   | 主な権限・機能                                                               |
|------------------|-----------------------------------------------------------------------------|
| 全ユーザー       | ガチャ一覧閲覧、ガチャ詳細閲覧、ガチャ実行、自分のガチャ作成・編集・削除      |
| 管理者           | 全ガチャの分析統計閲覧、ユーザー行動分析、デモグラフィック分析                |

**注意**: 基本は全ユーザーが同等権限。管理者は分析機能のみ追加権限。

## 4. 画面仕様・URL構造


### 4.1 ガチャを引く側の機能

- **ガチャ一覧画面** ✅ URL分離完了（パーソナライゼーション機能拡張）🆕
	- **URL**: `/gacha`
	- 利用可能なガチャのリスト表示
	- 各ガチャの簡易情報（名称、価格、提供割合など）
	- 自分が作成したガチャと他のユーザーが作成したガチャを区別表示
	- **拡張ソート機能**: おすすめ順、評価順を追加
	- **カテゴリフィルタリング**: 複数選択対応
	- **パーソナライゼーション**: おすすめ度表示、カテゴリタグ表示
	- **ユーザー評価**: 平均評価・レビュー件数表示
	- ガチャ詳細画面への遷移リンク

- **ガチャ詳細画面** ✅ 実装完了・URL分離完了
	- **URL**: `/gacha/:id`
	- ガチャの詳細情報（商品リスト、各商品の当選確率、説明）
	- 実際のAPIからデータ取得・表示
  - 在庫状況の動的表示・SOLD OUT表示（SSEによるリアルタイム反映）
	- 作成者情報・アイテム数・提供期間表示
	- レスポンシブ対応のカード形式レイアウト
	- URL パラメータからガチャIDを取得

- **ガチャ演出画面** ✅ 実装完了
	- ガチャ演出（リッチなアニメーション、パーティクル、2D/3D表現など）
	  - Framer MotionによるUIアニメーション ✅
	  - 実際のAPIレスポンスに基づく結果表示 ✅
	  - 獲得アイテムの詳細情報表示 ✅
	- 結果表示（当選商品） ✅

### 4.2 ガチャを作る側の機能

- **マイガチャ管理画面** ✅ URL分離完了
	- **URL**: `/my-gacha`
	- 自分が作成したガチャのリスト表示（ページネーション対応）
	- 編集・削除・新規作成ボタン
	- 公開/非公開の即座切り替え
	- ガチャの実行統計表示（将来対応）
	- ガチャ編集画面への遷移リンク

- **ガチャ新規作成画面** ✅ URL分離完了
	- **URL**: `/my-gacha/new`
	- ガチャ名、説明、価格、公開状態、表示期間の新規登録
	- 保存後は自動的にガチャ編集画面に遷移してアイテム管理可能

- **ガチャ編集画面** ✅ URL分離完了
	- **URL**: `/my-gacha/edit/:id`
	- ガチャ名、説明、価格、公開状態、表示期間の編集
	- アイテム管理機能（アイテム名、説明、画像URL、在庫数）
	- URL パラメータからガチャIDを取得
	- 既存ガチャの情報を自動読み込み
	- 新規作成後は自動的にアイテム管理セクションを表示
	- リアルタイムバリデーションとエラー表示

- **マイガチャ状況確認画面** ✅ 新規追加
	- **URL**: `/my-gacha/:id/status`
	- **機能**:
	  - アイテムごとの在庫状況を表示。
	  - アイテムの当選者情報を表示。
	  - ページネーション対応（当選者情報が多い場合）。
	- **認証要否**: 必須（ログイン済みユーザーのみアクセス可能）。
	- **レイアウト**:
	  - **ヘッダー**: ガチャ名、ガチャの説明。
	  - **アイテム在庫状況セクション**:
	    - アイテム名、残り数、初期在庫数。
	    - 残り数が0の場合は「SOLD OUT」を表示。
	  - **当選者情報セクション**:
	    - 当選者のユーザー名、メールアドレス、当選アイテム名、ガチャ排出日時。
	    - ページネーション（20件/ページ）。
	  - **フッター**: 「マイガチャ画面へ戻る」ボタン。

### 4.3 認証・プロフィール・履歴関連画面

- **ログイン画面**
	- メールアドレス・パスワード入力フォーム
	- ログインボタン
	- 新規登録画面へのリンク
	- パスワードリセット機能（将来対応）
	- ソーシャルログイン対応（Google、GitHub等）（将来対応）

- **新規登録画面**
	- ユーザー名、メールアドレス、パスワード入力フォーム
	- パスワード確認入力
	- 利用規約同意チェックボックス
	- 登録ボタン
	- ログイン画面へのリンク

- **プロフィール管理画面**
  - `/profile`
  - ユーザー情報表示・編集（アイコン/名前/メール/パスワード）
  - Sharp.js+MinIOによるアバター画像アップロード・削除
  - Yup/Joiバリデーション
  - 作成ガチャ一覧・ガチャ履歴へのリンク
  - ログアウト機能

- **ユーザー設定画面** 🆕 新規追加
  - **URL**: `/profile/preferences`
  - ガチャ表示順の個人設定（新しい順、人気順、おすすめ順等）
  - パーソナライゼーション機能のオン/オフ
  - 興味カテゴリ別レベル設定（1-5スライダー）
  - テーマ設定（ライト/ダーク/自動）
  - 通知設定（新ガチャ通知、お気に入り更新通知）
  - 設定保存・リセット機能

- **ガチャ履歴画面** ✅ 実装完了
	- **URL**: `/gacha-history`
	- ユーザーのガチャ実行履歴を時系列表示
	- 表示項目: 実行日時、ガチャ名、獲得アイテム名、アイテムサムネイル画像
	- ページネーション対応（20件/ページ）
	- 認証が必要（PrivateRoute）
	- ヘッダーのユーザーアイコンメニューから遷移

### 4.4 管理者専用機能 🆕

- **管理者分析ダッシュボード**
  - **URL**: `/admin/analytics`
  - 全体統計サマリー（総ガチャ数、総抽選回数、総ユーザー数、期間別収益）
  - 人気ガチャランキング表示
  - 時間別利用グラフ（Recharts使用）
  - 男女比・年齢別分布分析
  - デモグラフィック別収益分析テーブル
  - 期間選択フィルター（今日、今週、今月、カスタム期間）
  - データエクスポート機能（CSV、PDF）
  - 認証: 管理者権限必須

### 4.5 共通ヘッダー仕様

全画面に共通表示されるヘッダーバー（AppBar）の仕様を定義します。

#### 3.4.1 ヘッダー基本構成
- **左側**: サイトロゴ + サイト名「オンラインガチャ」
- **中央**: ナビゲーションメニュー
  - 「ガチャ一覧」（/gacha）
  - 「マイガチャ」（/my-gacha）※ログイン時のみ表示
  - 「分析ダッシュボード」（/admin/analytics）※管理者のみ表示 🆕
- **右側**: ユーザー関連メニュー

#### 3.4.2 ユーザーアイコン機能**【✅ 実装完了】**

**ログイン済み状態**:
- **表示**: ユーザーアバター画像（32px円形）
- **アバター仕様**:
  - 設定済み: user_avatar_variants.image_url (avatar_64.avif)
  - 未設定: ユーザー名の頭文字をアイコン表示
- **クリック動作**: ドロップダウンメニュー表示
  - 「プロフィール」→ `/profile` へ遷移
  - 「ユーザー設定」→ `/profile/preferences` へ遷移 🆕
  - 「ガチャ履歴」→ `/gacha-history` へ遷移 ✅ 実装完了
  - 「ログアウト」→ ログアウト実行

**未ログイン状態**:
- **表示**: 「ログイン」「登録」ボタン
- **アバターアイコン**: 非表示

#### 3.4.3 技術仕様
- **コンポーネント**: Material-UI AppBar + Avatar + Menu
- **認証状態管理**: React Context API
- **アバター画像**: Sharp.js処理済みAVIF画像（64px→32px表示）
- **メニュー制御**: Material-UI Menu コンポーネント
- **レスポンシブ**: モバイル時はハンバーガーメニュー化

#### 3.4.4 ユーザビリティ
- アバタークリックでのメニュー表示・非表示
- メニュー外クリックでの自動クローズ
- キーボードアクセシビリティ（Tab/Enter操作）
- ホバー時のツールチップ表示
- ログアウト時の確認ダイアログ（オプション）


## 5. ガチャ在庫リアルタイム同期設計（SSE）

### 概要
ガチャ詳細画面では、在庫数が他ユーザーの操作によって変動した場合も即時にUIへ反映されます。これにより、在庫切れ時の誤操作や在庫数のズレを防止します。

### サーバー側
- SSEエンドポイント `/api/gachas/:id/stock/stream` を提供
- 在庫数が変更されるたびに該当ガチャIDの購読者へ最新在庫数を送信
- Fastify + fastify-sse等で実装

### クライアント側
- ガチャ詳細画面でEventSourceを用いてSSE購読
- 受信した在庫数でUIを即時更新
- SOLD OUT時はボタン非活性・表示切替

### メッセージ仕様（例）
```json
event: stock_update
data: { "gachaId": 123, "stock": 5 }
```

### 拡張性
- 今後、ガチャ実行履歴や当選演出のリアルタイム配信にもSSEを活用可能


## 6. 技術仕様
- フロントエンド: React 18, Material-UI, Framer Motion, React Router, Swiper.js
- バックエンド: Node.js, Fastify, JWT認証, Joiバリデーション, PostgreSQL, MinIO, Sharp.js
- DB: PostgreSQL 16
- ストレージ: MinIO（S3互換, 画像は4サイズAVIF/WebP/JPEG自動生成）
- 画像処理: Sharp.js（高圧縮・高品質・多サイズ）
- インフラ: Docker Compose

### 4.1 認証システム
- **認証方式**: JWT（JSON Web Token）
- **セッション管理**: HttpOnly Cookie
- **パスワード**: bcryptでハッシュ化
- **セキュリティ**: CORS設定、レート制限対応

## 7. データベース設計（概略）

### 7.1 既存テーブル
- users（ユーザー情報）- デモグラフィック情報を追加（gender, birth_year, age_group）🆕
- gachas（ガチャ情報）- user_idでユーザーと関連付け
- gacha_items（ガチャ内のアイテム情報）- rarityカラムなし、image_urlはMinIO上のオブジェクトキーを格納
- gacha_results（ガチャ実行履歴）- 将来実装予定
- user_avatar_images, user_avatar_variants（ユーザーアバター画像情報, 実装済）

### 7.2 分析・パーソナライゼーション関連テーブル 🆕
- **gacha_statistics**（ガチャ統計）- 総抽選回数、ユニークユーザー数、収益、デモグラフィック統計
- **user_activity_logs**（ユーザー行動ログ）- ガチャ閲覧、抽選、お気に入り等の行動記録
- **gacha_hourly_stats**（時間別統計）- 1時間単位でのガチャ利用統計
- **user_preferences**（ユーザー設定）- 表示順、テーマ、通知設定、パーソナライゼーション設定
- **gacha_categories**（ガチャカテゴリ）- アニメ、ゲーム、音楽等のカテゴリ分類
- **user_interest_categories**（ユーザー興味カテゴリ）- カテゴリ別興味レベル（1-5）
- **gacha_category_mappings**（ガチャカテゴリマッピング）- ガチャとカテゴリの関連付け
- **gacha_demographic_stats**（デモグラフィック統計）- 性別・年齢別の詳細統計
- **user_gacha_ratings**（ユーザーガチャ評価）- ガチャの評価・レビュー・お気に入り

### 7.1 画像管理設計
- **保存先**: MinIO (S3互換オブジェクトストレージ)
- **画像処理**: Sharp.js（高性能画像処理ライブラリ）
- **画像形式**: AVIF形式（次世代画像フォーマット、WebP/JPEGのfallback対応）
- **複数サイズ生成**:
  - オリジナル: 元ファイルのAVIF変換版（最大2048x2048）
  - サムネイル: 150x150px（アイテム一覧用）
  - モバイル用: 512x512px（スマートフォン表示用）
  - 高解像度用: 1024x1024px（PC・タブレット表示用）
- **バケット構成**:
  - `gacha-images`: ガチャアイテム画像（4サイズ保存）
  - `user-avatars`: ユーザープロフィール画像（AVIF/4サイズ, 実装済）
- **画像URL形式**: `http://localhost:9000/gacha-images/{サイズ}/{オブジェクトキー}`
- **アクセス制御**: パブリック読み取り許可（画像表示用）
- **サイズ制限**: アップロード時最大10MB、圧縮後はサイズ最適化
- **レスポンシブ画像配信**: 端末に応じた最適サイズの自動選択


## 8. 機能一覧

| 機能名             | 概要                                         | 対象ユーザー   | 認証要否 | 実装状況 |
|--------------------|----------------------------------------------|---------------|----------|----------|
| ユーザー登録       | 新規アカウント作成                           | 未登録ユーザー | 不要     | ✅ 完了   |
| ログイン           | メールアドレス・パスワードでログイン         | 登録済みユーザー | 不要     | ✅ 完了   |
| ログアウト         | セッション終了                               | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ一覧表示     | 公開ガチャのリスト表示・検索・ソート機能     | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャカテゴリ一覧 | ガチャカテゴリの取得                         | 全ユーザー    | 不要     | ✅ 完了   |
| 人気ガチャ一覧     | プレイ回数順での人気ガチャ表示               | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ統計情報     | ガチャ数・プレイ数・プレイヤー数の統計       | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ詳細表示     | ガチャの詳細情報を表示（在庫SSEリアルタイム反映） | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ実行         | ガチャを引き、結果を表示                     | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ在庫リアルタイム同期 | 在庫数のSSEリアルタイム配信・UI反映      | 全ユーザー    | 不要     | ✅ 完了   |
| マイガチャ管理     | 自分が作成したガチャの一覧・管理             | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ作成・編集   | ガチャの新規作成・編集・削除                  | ログイン済み   | 必要     | ✅ 完了   |
| アイテム管理       | ガチャ内アイテムの登録・編集・削除            | ログイン済み   | 必要     | ✅ 完了   |
| 画像アップロード   | アイテム画像のMinIOへのアップロード          | ログイン済み   | 必要     | ❌ 未実装 |
| 画像管理           | アップロード済み画像の一覧・削除              | ログイン済み   | 必要     | ❌ 未実装 |
| アバター画像管理   | プロフィール画像のアップロード・削除          | ログイン済み   | 必要     | ✅ 完了   |
| プロフィール管理   | ユーザー情報編集・アバター設定               | ログイン済み   | 必要     | ✅ 完了   |
| ヘッダーアイコン   | ヘッダーのユーザーアバター表示・メニュー     | ログイン済み   | 必要     | ✅ 完了   |
| マイガチャ状況確認 | 自分が作成したガチャの在庫状況・当選者情報を確認 | ログイン済み   | 必要     | ❌ 未実装 |
| ユーザー設定管理   | 表示順、興味カテゴリ、テーマ、通知等の個人設定   | ログイン済み   | 必要     | 🆕 新規   |
| パーソナライゼーション | ユーザー設定に基づくおすすめガチャ表示       | ログイン済み   | 必要     | 🆕 新規   |
| ガチャ評価・レビュー   | ガチャの星評価・レビュー投稿・お気に入り     | ログイン済み   | 必要     | 🆕 新規   |
| 管理者分析ダッシュボード | 全ガチャの統計・ユーザー行動・デモグラフィック分析 | 管理者のみ   | 必要     | 🆕 新規   |

## 9. Docker構成

- web: Webアプリケーション
- frontend: Reactフロントエンド（開発環境）
- db: PostgreSQL
- minio: MinIO（S3互換オブジェクトストレージ）
- minio-init: MinIO初期化（バケット作成・設定）

```yaml
version: '3'
services:
  web:
    build: ./web
    ports:
      - "8080:8080"
    depends_on:
      - db
      - minio
    env_file:
      - .env
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: gacha_db
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_password
    ports:
      - "9000:9000"  # MinIO API
      - "9001:9001"  # MinIO Console
    volumes:
      - minio_data:/data
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minio_user minio_password;
      mc mb myminio/gacha-images;
      mc anonymous set download myminio/gacha-images;
      echo 'MinIO初期化完了';
      "
    restart: "no"
volumes:
  db_data:
  minio_data:
```

## 10. 今後の検討事項

### 10.1 基盤機能
- 認証・認可方式の強化
- 決済機能の有無
- 商品発送管理の有無
- CDN連携による画像配信の高速化
- 画像のメタデータ管理（サイズ、フォーマット、アップロード日時等）
- 画像の不正利用対策（透かし、アクセス制限等）
- WebP・JPEG fallback対応（古いブラウザサポート）
- 画像の遅延読み込み・プリロード機能
- 画像圧縮率の動的調整

### 10.2 分析・パーソナライゼーション機能拡張
- より高度なレコメンドアルゴリズム（機械学習ベース）
- A/Bテスト機能との統合
- リアルタイムデータ更新（WebSocket対応）
- 予測分析機能（需要予測、トレンド分析）
- ソーシャル機能（シェア、コメント、フォロー）
- カスタムレポート作成機能
- アラート・通知システム強化
- 多言語対応（国際化）
- GDPR対応のデータプライバシー強化

## 11. 最新の変更履歴

### 2025年8月23日 - Sharp.js画像処理システム統合設計
- **画像処理エンジン**:
  - Sharp.js統合: 高性能画像処理ライブラリ
  - AVIF形式対応: 次世代画像フォーマット（50%以上のファイルサイズ削減）
  - WebP/JPEG fallback: ブラウザサポート確保

- **複数サイズ画像生成**:
  - オリジナル: 最大2048x2048px（AVIF形式）
  - サムネイル: 150x150px（一覧表示用）
  - モバイル用: 512x512px（スマートフォン最適化）
  - 高解像度用: 1024x1024px（PC・タブレット用）

- **レスポンシブ画像配信**:
  - フロントエンド自動選択: デバイス・画面サイズに応じた最適画像
  - ブラウザサポート判定: AVIF未対応時のWebP/JPEG自動切り替え
  - 遅延読み込み対応: 表示領域に入った時点で画像読み込み

- **システム構成更新**:
  - アップロード時の自動処理: 4サイズ×3フォーマット生成
  - MinIOバケット構造変更: サイズ別ディレクトリ構成
  - データベーススキーマ拡張: 画像メタデータテーブル追加予定

### 2025年8月24日 - ユーザーアバターシステム統合**【✅ 実装完了】**
- **ユーザーアイコン機能**:
  - プロフィール画面でのアバター変更機能
  - Sharp.js処理: AVIF形式、4サイズ（32px/64px/128px/256px）自動生成
  - データベース設計: user_avatar_images, user_avatar_variants テーブル追加

- **ヘッダーアイコン機能**:
  - ログイン時のユーザーアバター表示（32px円形）
  - クリックメニュー: 「プロフィール」「ログアウト」
  - 未ログイン時: アバター非表示、ログイン/登録ボタン表示
  - レスポンシブ対応: モバイル時ハンバーガーメニュー化

- **統合表示機能**:
  - ガチャ一覧でのクリエイターアイコン表示
  - 64px画像を32pxサイズで表示
  - アイコン未設定時の頭文字フォールバック

### 2025年8月22日 - MinIO画像ストレージ統合
- **インフラ改修**:
  - MinIOコンテナの追加: S3互換オブジェクトストレージ
  - docker-compose.yml: MinIOサービスと初期化スクリプトの追加
  - 環境変数: MinIO接続設定の追加（.env）

- **画像管理設計**:
  - 画像保存先をMinIOに変更（従来のローカルファイルシステムから移行）
  - バケット構成: `gacha-images`（アイテム画像）、`user-images`（プロフィール画像、将来対応）
  - アクセス制御: パブリック読み取り許可による直接画像表示
  - ファイル制限: 最大5MB、JPEG/PNG/WebP対応

- **システム構成更新**:
  - バックエンド: MinIO Clientライブラリの統合予定
  - データベース設計: gacha_itemsのimage_urlをMinIOオブジェクトキー対応
  - 新機能追加予定: 画像アップロード・管理機能

### 2025年8月30日 - ガチャ分析・趣味嗜好機能追加 🆕
- **パーソナライゼーション機能**:
  - ユーザー設定画面: 表示順、興味カテゴリ、テーマ、通知設定
  - おすすめ順ソート: ユーザーの興味に基づくガチャ推薦
  - カテゴリフィルタリング: 複数選択対応、ガチャ件数表示
  - ユーザー評価システム: 星評価、レビュー、お気に入り機能

- **管理者分析機能**:
  - 分析ダッシュボード: 全体統計、人気ガチャランキング、時間別利用グラフ
  - デモグラフィック分析: 男女比・年齢別分布・収益分析
  - ユーザー行動分析: アクセスパターン、利用傾向の可視化
  - リアルタイム統計: ガチャ抽選時の即座統計更新

- **データベース拡張**:
  - 9つの新テーブル追加: 統計、ログ、設定、カテゴリ、評価関連
  - usersテーブル拡張: デモグラフィック情報追加
  - ハイブリッド統計更新: リアルタイム + 1時間毎バッチ処理

- **UI/UX改善**:
  - パーソナライゼーション状態表示: ログイン促進、設定ガイダンス
  - Recharts統合: インタラクティブなグラフ・チャート表示
  - Material-UI拡張: スライダー、チップ、評価コンポーネント

### 2025年8月21日 - URL構造の分離実装
- **フロントエンド改修**:
  - ガチャ一覧とガチャ詳細のURL分離: `/gacha` → `/gacha/:id`
  - マイガチャ管理とガチャ編集のURL分離: `/my-gacha` → `/my-gacha/edit/:id`
  - 新規ガチャ作成の独立URL: `/my-gacha/new`

- **ルーティング改善**:
  - React Router による URL パラメータベースのナビゲーション
  - 各コンポーネントの props 依存からURL パラメータ依存への移行
  - ブラウザの戻る/進むボタン対応の改善

- **コンポーネント修正**:
  - `AdminGachaEdit.js`: URL パラメータからガチャID取得に変更
  - `UserGachaDetail.js`: URL パラメータによるガチャ詳細取得
  - `App.js`: 新しいルーティング構造の実装

- **API修正**:
  - バックエンドAPI endpoints の修正
  - Gacha.js model の update メソッド強化
  - admin.js routes の endpoint 実装改善
