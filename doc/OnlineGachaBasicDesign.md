---

# オンラインガチャシステム 基本設計書（ドラフト）

## 1. システム概要

本システムは、ユーザーがオンライン上でガチャを引き、商品を獲得できるWebサービスです。すべてのユーザーはガチャを作成・管理することも、他のユーザーが作成したガチャを引くこともできます。システムはDocker環境上で動作し、データベースにはPostgreSQLを使用します。

## 2. ユーザー権限

| ユーザーロール   | 主な権限・機能                                                               |
|------------------|-----------------------------------------------------------------------------|
| 全ユーザー       | ガチャ一覧閲覧、ガチャ詳細閲覧、ガチャ実行、自分のガチャ作成・編集・削除      |

**注意**: すべてのユーザーは同等の権限を持ち、ガチャの作成と実行の両方が可能です。管理者という特別な権限は現在の実装には存在しません。

## 3. 画面仕様

### 3.1 ガチャを引く側の機能

- **ガチャ一覧画面**
	- 利用可能なガチャのリスト表示
	- 各ガチャの簡易情報（名称、価格、提供割合など）
	- 自分が作成したガチャと他のユーザーが作成したガチャを区別表示

- **ガチャ詳細画面** ✅ 実装完了
	- ガチャの詳細情報（商品リスト、各商品の当選確率、説明）
	- 実際のAPIからデータ取得・表示
	- 在庫状況の動的表示・SOLD OUT表示
	- 作成者情報・アイテム数・提供期間表示
	- レスポンシブ対応のカード形式レイアウト

- **ガチャ演出画面** ✅ 実装完了
	- ガチャ演出（リッチなアニメーション、パーティクル、2D/3D表現など）
	  - Framer MotionによるUIアニメーション ✅
	  - 実際のAPIレスポンスに基づく結果表示 ✅
	  - 獲得アイテムの詳細情報表示 ✅
	- 結果表示（当選商品） ✅

### 3.2 ガチャを作る側の機能

- **ガチャ管理画面**
	- 自分が作成したガチャのリスト表示（ページネーション対応）
	- 編集・削除・新規作成ボタン
	- 公開/非公開の即座切り替え
	- ガチャの実行統計表示（将来対応）

- **ガチャ作成・編集画面**
	- ガチャ名、説明、価格、公開状態、表示期間の登録・編集
	- アイテム管理機能（アイテム名、説明、画像URL、在庫数）
	- 新規作成後は自動的にアイテム管理セクションを表示
	- リアルタイムバリデーションとエラー表示

### 3.3 認証関連画面

- **ログイン画面**
	- メールアドレス・パスワード入力フォーム
	- ログインボタン
	- 新規登録画面へのリンク
	- パスワードリセット機能（将来対応）
	- ソーシャルログイン対応（Google、GitHub等）（将来対応）

- **新規登録画面**
	- ユーザー名、メールアドレス、パスワード入力フォーム
	- パスワード確認入力
	- 利用規約同意チェックボックス
	- 登録ボタン
	- ログイン画面へのリンク

- **プロフィール画面**
	- ユーザー情報表示・編集
	- ガチャ実行履歴表示
	- 作成したガチャ一覧
	- ログアウト機能

## 4. システム構成

- **Webアプリケーション**
	- フロントエンド：React + Material-UI + React Hook Form
	  - React Router: ページルーティング
	  - React Hook Form + Yup: フォーム管理・バリデーション
	  - Material-UI: UIコンポーネント
	  - Framer Motion: UIアニメーション
	  - Three.js / PixiJS: ガチャ演出（2D/3Dアニメーション、パーティクル等）
	- バックエンド：Node.js（Fastify）+ JWT認証
	  - Fastify: 高速Webフレームワーク
	  - JWT: ステートレス認証
	  - bcrypt: パスワードハッシュ化
	  - PostgreSQL: データベースアクセス
- **DB**：PostgreSQL
- **インフラ**：Docker（docker-composeでWeb/DBを構築）

### 4.1 認証システム
- **認証方式**: JWT（JSON Web Token）
- **セッション管理**: HttpOnly Cookie
- **パスワード**: bcryptでハッシュ化
- **セキュリティ**: CORS設定、レート制限対応

## 5. データベース設計（概略）

- users（ユーザー情報）- roleカラム削除済み
- gachas（ガチャ情報）- user_idでユーザーと関連付け
- gacha_items（ガチャ内のアイテム情報）- rarityカラムなし
- gacha_results（ガチャ実行履歴）- 将来実装予定
- gachas_images（ガチャ画像情報）- 将来実装予定

## 6. 機能一覧

| 機能名             | 概要                                         | 対象ユーザー   | 認証要否 | 実装状況 |
|--------------------|----------------------------------------------|---------------|----------|----------|
| ユーザー登録       | 新規アカウント作成                           | 未登録ユーザー | 不要     | ✅ 完了   |
| ログイン           | メールアドレス・パスワードでログイン         | 登録済みユーザー | 不要     | ✅ 完了   |
| ログアウト         | セッション終了                               | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ一覧表示     | 公開ガチャのリスト表示・検索・ソート機能     | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャカテゴリ一覧 | ガチャカテゴリの取得                         | 全ユーザー    | 不要     | ✅ 完了   |
| 人気ガチャ一覧     | プレイ回数順での人気ガチャ表示               | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ統計情報     | ガチャ数・プレイ数・プレイヤー数の統計       | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ詳細表示     | ガチャの詳細情報を表示                       | 全ユーザー    | 不要     | ✅ 完了   |
| ガチャ実行         | ガチャを引き、結果を表示                     | ログイン済み   | 必要     | ✅ 完了   |
| マイガチャ管理     | 自分が作成したガチャの一覧・管理             | ログイン済み   | 必要     | ✅ 完了   |
| ガチャ作成・編集   | ガチャの新規作成・編集・削除                  | ログイン済み   | 必要     | ✅ 完了   |
| アイテム管理       | ガチャ内アイテムの登録・編集・削除            | ログイン済み   | 必要     | ✅ 完了   |
| プロフィール管理   | ユーザー情報編集・実行履歴確認               | ログイン済み   | 必要     | ❌ 未実装 |

## 7. Docker構成（例）

- web: Webアプリケーション
- db: PostgreSQL

```yaml
version: '3'
services:
	web:
		build: .
		ports:
			- "8080:8080"
		depends_on:
			- db
	db:
		image: postgres:16
		environment:
			POSTGRES_USER: user
			POSTGRES_PASSWORD: password
			POSTGRES_DB: gacha_db
		ports:
			- "5432:5432"
		volumes:
			- db_data:/var/lib/postgresql/data
volumes:
	db_data:
```

## 8. 今後の検討事項

- 認証・認可方式
- 決済機能の有無
- 商品発送管理の有無

---
